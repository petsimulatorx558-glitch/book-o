-- Create the main ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = game:GetService("CoreGui")

-- Create the menu button
local menuButton = Instance.new("TextButton")
menuButton.Size = UDim2.new(0, 80, 0, 40)
menuButton.Position = UDim2.new(0, 10, 0, 10)
menuButton.Text = "Menu"
menuButton.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
menuButton.TextColor3 = Color3.fromRGB(255, 255, 255)
menuButton.TextScaled = true
menuButton.Parent = screenGui

-- Create the main GUI frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 400)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.Visible = false
mainFrame.Parent = screenGui

-- Create the dragable area
local dragArea = Instance.new("Frame")
dragArea.Size = UDim2.new(1, 0, 0, 40)
dragArea.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
dragArea.Parent = mainFrame

-- Create the close button (X)
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 40, 0, 40)
closeButton.Position = UDim2.new(1, -40, 0, 0)
closeButton.Text = "X"
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextScaled = true
closeButton.Parent = dragArea

-- Create the minimize button
local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0, 40, 0, 40)
minimizeButton.Position = UDim2.new(1, -80, 0, 0)
minimizeButton.Text = "-"
minimizeButton.BackgroundColor3 = Color3.fromRGB(50, 50, 200)
minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.TextScaled = true
minimizeButton.Parent = dragArea

-- Minimize/Unminimize overlay
local unminimizeButton = Instance.new("TextButton")
unminimizeButton.Size = UDim2.new(0, 80, 0, 40)
unminimizeButton.Position = UDim2.new(0, 10, 0, 60)
unminimizeButton.Text = "Unminimize"
unminimizeButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
unminimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
unminimizeButton.TextScaled = true
unminimizeButton.Visible = false
unminimizeButton.Parent = screenGui

-- Create the title label
local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(0, 200, 0, 40)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.Text = "Menu"
titleLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextScaled = true
titleLabel.Parent = dragArea

-- Create the content area
local contentArea = Instance.new("Frame")
contentArea.Size = UDim2.new(1, 0, 1, -40)
contentArea.Position = UDim2.new(0, 0, 0, 40)
contentArea.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
contentArea.Parent = mainFrame

-- Create categories
local categories = {"Home", "ESP", "About"}
local categoryButtons = {}
local categoryFrames = {}

for i, category in ipairs(categories) do
    -- Create category button
    local categoryButton = Instance.new("TextButton")
    categoryButton.Size = UDim2.new(0, 100, 0, 50)
    categoryButton.Position = UDim2.new(0, 10 + (i - 1) * 110, 0, 0)
    categoryButton.Text = category
    categoryButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    categoryButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    categoryButton.TextScaled = true
    categoryButton.Parent = contentArea
    table.insert(categoryButtons, categoryButton)

    -- Create category frame
    local categoryFrame = Instance.new("Frame")
    categoryFrame.Size = UDim2.new(1, 0, 1, -50)
    categoryFrame.Position = UDim2.new(0, 0, 0, 50)
    categoryFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    categoryFrame.Visible = i == 1 -- Show only the first category initially
    categoryFrame.Parent = contentArea
    table.insert(categoryFrames, categoryFrame)
end

-- Notification function
local function Notify(tbl)
    game.StarterGui:SetCore("SendNotification", tbl)
end

-- Role finder functions (improved)
local function findMurderer()
    for _, plr in ipairs(game.Players:GetPlayers()) do
        if plr:FindFirstChild("Backpack") and plr.Backpack:FindFirstChild("Knife") then
            return plr.Name
        end
        if plr.Character and plr.Character:FindFirstChild("Knife") then
            return plr.Name
        end
    end
    return nil
end

local function findSheriff()
    for _, plr in ipairs(game.Players:GetPlayers()) do
        if plr:FindFirstChild("Backpack") and plr.Backpack:FindFirstChild("Gun") then
            return plr.Name
        end
        if plr.Character and plr.Character:FindFirstChild("Gun") then
            return plr.Name
        end
    end
    return nil
end

-- Track murderer/sheriff
local imposter = findMurderer()
local pig = findSheriff()

-- Update roles and ESP every round (detect by listening to round-related remotes/events)
local function UpdateRoles()
    imposter = findMurderer()
    pig = findSheriff()
end

game.Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        UpdateRoles()
    end)
end)

for _, plr in ipairs(game.Players:GetPlayers()) do
    plr.CharacterAdded:Connect(UpdateRoles)
end

-- ESP logic
local espEnabled = false
local function clearESP()
    for _, plr in pairs(game.Players:GetPlayers()) do
        if plr.Character then
            for _, obj in ipairs(plr.Character:GetDescendants()) do
                if obj:IsA("BoxHandleAdornment") then
                    obj:Destroy()
                end
            end
        end
    end
end

local function addESPToPlayer(player, color)
    if not player.Character then return end
    for _, part in ipairs(player.Character:GetDescendants()) do
        if (part:IsA("Part") or part:IsA("MeshPart")) then
            -- Remove old ESP
            for _, adorn in ipairs(part:GetChildren()) do
                if adorn:IsA("BoxHandleAdornment") then adorn:Destroy() end
            end
            -- Add new
            local espBox = Instance.new("BoxHandleAdornment")
            espBox.Parent = part
            espBox.Adornee = part
            espBox.AlwaysOnTop = true
            espBox.Transparency = 0.75
            espBox.Size = part.Size
            espBox.Color3 = color
            espBox.ZIndex = 0
        end
    end
end

local function applyESP()
    clearESP()
    if not espEnabled then return end
    imposter = findMurderer()
    pig = findSheriff()
    for _, plr in ipairs(game.Players:GetPlayers()) do
        if plr.Name == imposter then
            addESPToPlayer(plr, Color3.fromRGB(255, 0, 4))
        elseif plr.Name == pig then
            addESPToPlayer(plr, Color3.fromRGB(0, 12, 255))
        end
    end
end

local function toggleESP()
    espEnabled = not espEnabled
    if espEnabled then
        Notify({
            Title = "ESP Enabled!",
            Text = "Players with roles will be highlighted.",
            Duration = 3
        })
    else
        clearESP()
        Notify({
            Title = "ESP Disabled.",
            Text = "",
            Duration = 2
        })
    end
    applyESP()
end

-- Listen for role detection on server invoke
local mt = getrawmetatable(game)
setreadonly(mt, false)
local oldNamecall = mt.__namecall

mt.__namecall = newcclosure(function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    if tostring(method) == "InvokeServer" and tostring(self) == "GetChance" then
        spawn(function()
            wait(8)
            UpdateRoles()
            if imposter then
                Notify({
                    Title = "The Murderer is",
                    Text = imposter,
                    Icon = "http://www.roblox.com/Thumbs/Avatar.ashx?x=150&y=150&Format=Png&username=" .. imposter,
                    Duration = 5
                })
            end
            if pig then
                Notify({
                    Title = "The Sheriff is",
                    Text = pig,
                    Icon = "http://www.roblox.com/Thumbs/Avatar.ashx?x=150&y=150&Format=Png&username=" .. pig,
                    Duration = 5
                })
            end
            applyESP()
        end)
    end
    return oldNamecall(self, table.unpack(args))
end)

-- Hooks for character added
local function onPlayerAdded(player)
    player.CharacterAdded:Connect(function()
        applyESP()
    end)
end

game.Players.PlayerAdded:Connect(onPlayerAdded)
for _, plr in pairs(game.Players:GetPlayers()) do
    onPlayerAdded(plr)
end

-- GUI visibility toggles
local function toggleMainGui()
    mainFrame.Visible = not mainFrame.Visible
end

local function minimizeMain()
    mainFrame.Visible = false
    unminimizeButton.Visible = true
end

local function unminimizeMain()
    mainFrame.Visible = true
    unminimizeButton.Visible = false
end

menuButton.MouseButton1Click:Connect(toggleMainGui)
closeButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = false
    unminimizeButton.Visible = false
end)
minimizeButton.MouseButton1Click:Connect(minimizeMain)
unminimizeButton.MouseButton1Click:Connect(unminimizeMain)

-- Make frame draggable (optimized)
local dragging, dragInput, dragStart, startPos
local userInput = game:GetService("UserInputService")

local function updateDrag(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

dragArea.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)

dragArea.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

userInput.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        updateDrag(input)
    end
end)

-- Category button logic
for i, button in ipairs(categoryButtons) do
    button.MouseButton1Click:Connect(function()
        for _, frame in ipairs(categoryFrames) do frame.Visible = false end
        categoryFrames[i].Visible = true
    end)
end

-- Connect ESP button
categoryButtons[2].MouseButton1Click:Connect(toggleESP)
